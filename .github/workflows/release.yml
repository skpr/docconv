name: üöÄ Publish Release

on:
  push:
    tags:
      - 'v?[0-9]+.[0-9]+.[0-9]+(-alpha[0-9]+|-beta[0-9]+)?'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: üì¶ Install Mise
        run: |
          curl https://mise.run | sh
          mise install

      - name: ‚öôÔ∏è Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: ‚öôÔ∏è Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîë Get signing key
        run: |
          echo "${{ secrets.SKPR_PRIVATE_KEY }}" > skpr.rsa
          chmod 600 skpr.rsa

      - name: üöÄ Publish Release
        run: mise release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üöÆ Delete signing key
        if: always()
        run: rm -f skpr.rsa

      - name: üîë Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: üì§ Upload APKs to S3
        run: |
          VERSION=${GITHUB_TAG}
          aws s3 sync \
            ./dist/docconv_${VERSION}_linux_arm64.apk \
            s3://package-skpr-io/docconv/${VERSION}/aarch64/docconv_${VERSION}.apk \
            --acl public-read \
            --cache-control "max-age=86400" \
            --delete          
          aws s3 sync \
            ./dist/docconv_${VERSION}_linux_amd64.apk \
            s3://package-skpr-io/docconv/${VERSION}/x86_64/docconv_${VERSION}.apk \
            --acl public-read \
            --cache-control "max-age=86400" \
            --delete
          # upload public key for validating repository packages.
          aws s3 cp skpr.rsa.pub s3://package-skpr-io/docconv/skpr.rsa.pub --acl public-read

      - name: ‚òÅÔ∏è Invalidate CloudFront Cache
        run: |
          VERSION=${GITHUB_TAG}
          aws cloudfront create-invalidation --distribution-id ${CLOUDFRONT_ID} --paths /docconv/${VERSION}/* /docconv/skpr.rsa.pub
